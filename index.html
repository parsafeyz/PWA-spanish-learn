<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spanish by Levels (A1–C2) · Prisma‑style</title>
  <meta name="description" content="Single‑file site for Spanish vocabulary, grammar, and quizzes by CEFR level. Excel-friendly CSV import/export for content editing." />
  <style>
    :root{ --bg:#0b1020;--card:#101526;--elev:#121a2e;--text:#f2f5ff;--muted:#a7b3d6;--brand:#8b5cf6;--brand2:#22d3ee;--ok:#34d399;--warn:#fbbf24;--danger:#f87171;--radius:18px }
    /* refined light theme */
    body.light{ --bg:#f6f7fb; --card:#ffffff; --elev:#ffffff; --text:#0c1730; --muted:#6c7894; --brand:#6d28d9; --brand2:#0891b2; --ok:#16a34a; --warn:#d97706; --danger:#dc2626 }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:
      radial-gradient(1200px 800px at 100% -10%, rgba(139,92,246,.12), transparent 60%),
      radial-gradient(900px 700px at -20% 110%, rgba(34,211,238,.10), transparent 60%),
      var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(10px);background:linear-gradient(180deg, rgba(11,16,32,.75), rgba(11,16,32,.35));border-bottom:1px solid rgba(255,255,255,.06)}
    body.light header{background:linear-gradient(180deg, rgba(246,247,251,.85), rgba(246,247,251,.6));border-bottom-color:rgba(0,0,0,.06)}
    .head{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 0}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg, var(--brand), var(--brand2));box-shadow:0 10px 30px rgba(139,92,246,.35)}
    h1{font-size:1.15rem;margin:0}
    .sub{font-size:.92rem;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button,.chip{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 14px;background:var(--elev);color:var(--text);cursor:pointer;transition:transform .08s ease, box-shadow .2s ease, opacity .2s ease;box-shadow:0 6px 16px rgba(0,0,0,.15)}
    body.light button, body.light .chip{border-color:rgba(0,0,0,.08);box-shadow:0 6px 16px rgba(0,0,0,.06)}
    button:hover{transform:translateY(-1px)}
    .primary{background:linear-gradient(135deg, rgba(139,92,246,.25), rgba(34,211,238,.25));border-color:rgba(255,255,255,.18)}

    nav.breadcrumbs{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:12px 0;color:var(--muted)}
    nav.breadcrumbs .sep{opacity:.5}
    nav.breadcrumbs a{color:inherit;text-decoration:none}
    nav.breadcrumbs a:hover{color:var(--text)}

    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:16px}
    @media(max-width:1024px){.grid{grid-template-columns:repeat(4,1fr)}}
    @media(max-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}

    .card{background:linear-gradient(180deg, var(--card), rgba(255,255,255,0.02));border:1px solid rgba(139,92,246,.15);border-radius:var(--radius);padding:16px;position:relative;overflow:hidden}
    body.light .card{border-color:rgba(0,0,0,.08)}

    /* level card header (no overlap) */
    .level{cursor:pointer}
    .levelHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
    .lvl{font-weight:800;font-size:1.6rem;line-height:1;margin:0}
    .lvlTag{padding:6px 10px;border-radius:10px;background:rgba(34,211,238,.12);color:#0ea5e9;font-size:.78rem;white-space:nowrap;max-width:60%;overflow:hidden;text-overflow:ellipsis}
    body.light .lvlTag{background:rgba(8,145,178,.12);color:#0e7490}
    @media(max-width:1024px){.lvlTag{max-width:58%}}
    @media(max-width:720px){.lvl{font-size:1.4rem}.lvlTag{font-size:.72rem;max-width:56%}}

    .panel{margin-top:14px}
    .listlessons{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
    @media(max-width:1024px){.listlessons{grid-template-columns:repeat(4,1fr)}}
    @media(max-width:780px){.listlessons{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:520px){.listlessons{grid-template-columns:repeat(2,1fr)}}
    .lessonBtn{padding:16px;border-radius:14px;background:var(--elev);border:1px solid rgba(139,92,246,.18);cursor:pointer;display:flex;flex-direction:column;gap:6px;align-items:flex-start}
    .lessonBtn small{color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:rgba(139,92,246,.12);color:#c4b5fd;font-size:.75rem;font-weight:600}
    body.light .badge{background:rgba(109,40,217,.12);color:#6d28d9}

    .contentCard{background:var(--card);border:1px solid rgba(139,92,246,.15);border-radius:var(--radius);padding:18px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .tab{padding:10px 14px;border-radius:999px;background:var(--elev);border:1px solid rgba(139,92,246,.2);cursor:pointer}
    .tab.active{background:linear-gradient(135deg, rgba(139,92,246,.25), rgba(34,211,238,.25));border-color:rgba(255,255,255,.25)}
    .section{display:none}
    .section.active{display:block}

    .topic{margin:12px 0;padding:12px;border-radius:12px;background:var(--elev);border:1px solid rgba(139,92,246,.12)}
    .topic h4{margin:0 0 6px 0;font-size:1.05rem}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px dashed rgba(139,92,246,.2);padding:10px;border-radius:8px;text-align:left;vertical-align:top}
    thead th{background:rgba(139,92,246,.08)}
    .muted{color:var(--muted)}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="search"]{background:var(--elev);border:1px solid rgba(139,92,246,.22);color:var(--text);padding:10px 12px;border-radius:10px;outline:none}

    .credit{margin:22px auto 32px;opacity:.85;text-align:center}

    /* animations */
    .fadeIn{animation:fade .25s ease}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .slide{animation:slide .25s ease}
    @keyframes slide{from{opacity:0;transform:translateX(8px)}to{opacity:1;transform:none}}

    /* quiz visuals */
    .quiz-item{border:1px solid rgba(139,92,246,.18);border-radius:12px;padding:12px;margin:10px 0;background:var(--elev)}
    .quiz-choices{display:grid;gap:8px;margin-top:8px}
    .choice{display:flex;gap:8px;align-items:center;padding:8px;border:1px solid rgba(139,92,246,.15);border-radius:10px}
    .choice.correct{border-color:var(--ok);background:rgba(16,185,129,.14)}
    .choice.incorrect{border-color:var(--danger);background:rgba(248,113,113,.14)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:rgba(139,92,246,.12)}
    .scoreBox{display:flex;align-items:center;gap:10px;margin-top:10px}
    .scoreBig{font-size:1.25rem;font-weight:900;padding:6px 12px;border-radius:999px;background:linear-gradient(135deg, rgba(139,92,246,.25), rgba(34,211,238,.25));box-shadow:0 8px 24px rgba(0,0,0,.15)}

    /* level summary tooltip */
    #lvlTip{position:fixed;z-index:1000;display:none;pointer-events:none;max-width:320px;padding:10px 12px;border-radius:12px;background:var(--card);color:var(--text);border:1px solid rgba(139,92,246,.22);box-shadow:0 12px 30px rgba(0,0,0,.25);font-size:.9rem;line-height:1.35}
  </style>
</head>
<body>
  <header aria-label="Main header">
    <div class="container head">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Spanish by Levels · Prisma‑style</h1>
          <div class="sub">Pick your level → pick a lesson → Vocabulary · Grammar · Quiz</div>
        </div>
      </div>
      <div class="actions">
        <input id="csvFile" type="file" accept=".csv" hidden />
        <button id="themeBtn" class="chip" aria-pressed="false" title="Toggle light/dark">Theme</button>
        <button id="exportCsvBtn" class="chip" title="Export A1 to CSV (Excel)">Export CSV</button>
        <button id="importCsvBtn" class="chip" title="Import CSV for A1 (Excel)">Import CSV</button>
        <button id="backBtn" class="primary" hidden aria-label="Back">Back</button>
      </div>
    </div>
  </header>

  <main class="container" role="main">
    <nav class="breadcrumbs" id="crumbs" aria-label="Breadcrumb"></nav>

    <!-- Levels -->
    <section id="view-levels" class="panel fadeIn" aria-label="Levels"></section>

    <!-- Lessons -->
    <section id="view-lessons" class="panel fadeIn" hidden aria-label="Lessons">
      <div class="toolbar" style="margin-bottom:12px">
        <span class="badge" aria-hidden="true">Search</span>
        <input type="search" id="lessonSearch" placeholder="search lessons, vocab, grammar" aria-label="Search" />
      </div>
      <div id="lessonsGrid" class="listlessons" role="list"></div>
    </section>

    <!-- Lesson content -->
    <section id="view-content" class="panel fadeIn" hidden aria-label="Lesson content">
      <div class="contentCard slide">
        <h3 id="lessonTitle">Lesson</h3>
        <p class="muted" id="lessonMeta"></p>
        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="vocab" role="tab" aria-selected="true">Vocabulary</button>
          <button class="tab" data-tab="grammar" role="tab" aria-selected="false">Grammar</button>
          <button class="tab" data-tab="quiz" role="tab" aria-selected="false">Quiz</button>
        </div>
        <div id="section-vocab" class="section active" role="tabpanel"></div>
        <div id="section-grammar" class="section" role="tabpanel"></div>
        <div id="section-quiz" class="section" role="tabpanel"></div>
      </div>

      <div class="credit">Design by Parsa Feyz</div>
    </section>
  </main>

  <!-- floating tooltip for level summaries -->
  <div id="lvlTip" role="status" aria-live="polite"></div>

  <script>
    // ===== DATA =====
    const DATA = {
      A1: {
        title: "A1 — Beginner",
        lessonCount: 12,
        lessons: {
          1: {
            title: "Alphabet, Greetings, and SER",
            vocab: [
              { es: "hola", en: "hello" },
              { es: "adiós", en: "goodbye" },
              { es: "buenos días", en: "good morning" },
              { es: "buenas tardes", en: "good afternoon" },
              { es: "buenas noches", en: "good night / evening" },
              { es: "por favor", en: "please" },
              { es: "gracias", en: "thanks" },
              { es: "de nada", en: "you're welcome" },
              { es: "yo / tú / él, ella / usted", en: "I / you / he, she / you (formal)", group:true },
              { es: "ser", en: "to be (essential)" }
            ],
            grammar: [
              { title: "Personal pronouns", desc: "yo, tú, él/ella/usted, nosotros/as, vosotros/as, ellos/ellas/ustedes.", examples: [["Yo soy Ana.", "I am Ana."]] },
              { title: "SER (present)", desc: "soy, eres, es, somos, sois, son. Use for identity, origin, profession.", examples: [["Soy de México.", "I am from Mexico."], ["Ella es médica.", "She is a doctor."]] }
            ]
          },
          2: { title: "Articles, Gender & Number", vocab: [
              { es: "el", en: "the (masc. sing.)" }, { es: "la", en: "the (fem. sing.)" }, { es: "los", en: "the (masc. pl.)" }, { es: "las", en: "the (fem. pl.)" },
              { es: "un", en: "a / an (masc.)" }, { es: "una", en: "a / an (fem.)" }, { es: "unos", en: "some (masc.)" }, { es: "unas", en: "some (fem.)" },
              { es: "chico", en: "boy" }, { es: "chica", en: "girl" }
            ],
            grammar: [
              { title: "Articles", desc: "Definite vs. indefinite; agreement with noun.", examples: [["el libro", "the book"], ["una casa", "a house"]] },
              { title: "Gender & plural", desc: "-o (masc.), -a (fem.) with exceptions; plural: vowel + s / consonant + es.", examples: [["amigo → amigos"], ["papel → papeles"]] }
            ] },
          3: { title: "Present of Regular Verbs & ESTAR", vocab: [
              { es: "hablar", en: "to speak" }, { es: "comer", en: "to eat" }, { es: "vivir", en: "to live" }, { es: "estar", en: "to be (state/location)" },
              { es: "siempre", en: "always" }, { es: "a veces", en: "sometimes" }, { es: "nunca", en: "never" }, { es: "en casa", en: "at home" }, { es: "en la escuela", en: "at school" }
            ],
            grammar: [
              { title: "Regular conjugations", desc: "-AR: o, as, a, amos, áis, an; -ER: o, es, e, emos, éis, en; -IR: o, es, e, imos, ís, en.", examples: [["Yo hablo", "I speak"], ["Nosotros vivimos", "We live"]] },
              { title: "ESTAR (present)", desc: "estoy, estás, está, estamos, estáis, están. Temporary state & location.", examples: [["Estoy cansado.", "I am tired."], ["Madrid está en España.", "Madrid is in Spain."]] }
            ] },
          4: { title: "Numbers, Time & TENER", vocab: [
              { es: "cero", en: "zero" }, { es: "uno", en: "one" }, { es: "dos", en: "two" }, { es: "tres", en: "three" }, { es: "cuatro", en: "four" }, { es: "cinco", en: "five" },
              { es: "seis", en: "six" }, { es: "siete", en: "seven" }, { es: "ocho", en: "eight" }, { es: "nueve", en: "nine" }, { es: "diez", en: "ten" },
              { es: "once", en: "eleven" }, { es: "doce", en: "twelve" }, { es: "trece", en: "thirteen" }, { es: "catorce", en: "fourteen" }, { es: "quince", en: "fifteen" },
              { es: "veinte", en: "twenty" }, { es: "treinta", en: "thirty" }, { es: "cuarenta", en: "forty" }, { es: "la una", en: "one o'clock" }, { es: "las dos y media", en: "half past two" },
              { es: "tener", en: "to have" }
            ],
            grammar: [
              { title: "Telling the time", desc: "Es la una / Son las dos (y cinco / y cuarto / y media / menos diez).", examples: [["¿Qué hora es? — Son las tres y cuarto.", "3:15"]] },
              { title: "TENER (present)", desc: "tengo, tienes, tiene, tenemos, tenéis, tienen. Age & possession.", examples: [["Tengo 16 años.", "I am 16 years old."], ["Tenemos una clase.", "We have a class."]] },
              { title: "TENER expressions", desc: "tener hambre/sed/frío/calor/sueño; tener prisa.", examples: [["Tengo hambre.", "I'm hungry."]] }
            ] },
          5: { title: "Family & Possessives", vocab: [
              { es: "madre", en: "mother" }, { es: "padre", en: "father" }, { es: "hermano", en: "brother" }, { es: "hermana", en: "sister" },
              { es: "hijo", en: "son" }, { es: "hija", en: "daughter" }, { es: "abuelo", en: "grandfather" }, { es: "abuela", en: "grandmother" },
              { es: "esposo", en: "husband" }, { es: "esposa", en: "wife" }, { es: "pareja", en: "partner" }
            ],
            grammar: [
              { title: "Possessive adjectives", desc: "mi, tu, su, nuestro/a, vuestro/a, su (+ plurals).", examples: [["Mi hermano es alto.", "My brother is tall."]] },
              { title: "SER vs ESTAR (recap)", desc: "SER—permanent traits; ESTAR—temporary & location.", examples: [["Mi abuela es simpática.", "My grandma is nice."], ["Mi abuela está cansada.", "My grandma is tired."]] }
            ] },
          6: { title: "GUSTAR & Preferences", vocab: [
              { es: "me", en: "to me" }, { es: "te", en: "to you (sg.)" }, { es: "le", en: "to him/her" }, { es: "nos", en: "to us" }, { es: "os", en: "to you (pl.)" }, { es: "les", en: "to them" },
              { es: "película", en: "movie" }, { es: "música", en: "music" }, { es: "deporte", en: "sport" }, { es: "gustar", en: "to like" }, { es: "encantar", en: "to love" }, { es: "interesar", en: "to interest" }, { es: "molestar", en: "to bother" }
            ],
            grammar: [
              { title: "Structure of GUSTAR", desc: "(A mí) me gusta el café / (A ti) te gustan las películas.", examples: [["Nos gusta bailar.", "We like dancing."]] },
              { title: "Similar verbs", desc: "encantar, interesar, molestar. Agreement with thing liked.", examples: [["Me encantan los libros.", "I love books."]] }
            ] },
          7: { title: "Daily Routine & Reflexive Verbs", vocab: [
              { es: "despertarse", en: "to wake up" }, { es: "levantarse", en: "to get up" }, { es: "ducharse", en: "to shower" }, { es: "vestirse", en: "to get dressed" },
              { es: "desayunar", en: "to have breakfast" }, { es: "almorzar", en: "to have lunch" }, { es: "cenar", en: "to have dinner" },
              { es: "siempre", en: "always" }, { es: "normalmente", en: "usually" }, { es: "a veces", en: "sometimes" }
            ],
            grammar: [
              { title: "Reflexive pronouns", desc: "me, te, se, nos, os, se.", examples: [["Me levanto a las siete.", "I get up at 7."]] },
              { title: "Pronoun position", desc: "Before conjugated verb or attached to infinitive/gerund/affirmative imperative.", examples: [["Quiero ducharme.", "I want to shower."], ["¡Levántate!", "Get up!"]] }
            ] },
          8: { title: "Near Future & Plans (IR A + INF)", vocab: [
              { es: "voy", en: "I go" }, { es: "vas", en: "you go" }, { es: "va", en: "he/she goes" }, { es: "vamos", en: "we go" }, { es: "vais", en: "you (pl.) go" }, { es: "van", en: "they go" },
              { es: "este fin de semana", en: "this weekend" }, { es: "mañana", en: "tomorrow" },
              { es: "viajar", en: "to travel" }, { es: "estudiar", en: "to study" }, { es: "visitar", en: "to visit" }
            ],
            grammar: [
              { title: "IR A + infinitive", desc: "voy a + INF (intention/plan).", examples: [["Voy a estudiar mañana.", "I'm going to study tomorrow."]] },
              { title: "Present for scheduled future", desc: "Timetables can use present.", examples: [["Mañana tenemos examen.", "We have an exam tomorrow."]] }
            ] },
          9: { title: "Past: Pretérito Perfecto", vocab: [
              { es: "este año", en: "this year" }, { es: "esta semana", en: "this week" }, { es: "hoy", en: "today" }, { es: "ya", en: "already" }, { es: "todavía no", en: "not yet" },
              { es: "hacer", en: "to do" }, { es: "ver", en: "to see" }, { es: "decir", en: "to say" }
            ],
            grammar: [
              { title: "HABER + participle", desc: "he, has, ha, hemos, habéis, han + -ado/-ido.", examples: [["He comido.", "I have eaten."]] },
              { title: "Common irregular participles", desc: "hecho, visto, dicho, puesto, escrito, abierto, vuelto, roto.", examples: [["Hemos visto una película.", "We have seen a movie."]] }
            ] },
          10: { title: "Places, Prepositions & Directions", vocab: [
              { es: "banco", en: "bank" }, { es: "farmacia", en: "pharmacy" }, { es: "estación", en: "station" },
              { es: "a la derecha", en: "to the right" }, { es: "a la izquierda", en: "to the left" }, { es: "recto", en: "straight" },
              { es: "cerca de", en: "near" }, { es: "lejos de", en: "far from" }, { es: "entre", en: "between" }, { es: "frente a", en: "opposite" }
            ],
            grammar: [
              { title: "Prepositions", desc: "a, de, en, con, sin, por, para, sobre, entre, hasta, desde.", examples: [["Voy a la estación.", "I go to the station."]] },
              { title: "Contractions", desc: "a + el = al; de + el = del.", examples: [["Voy al banco.", "I go to the bank."]] }
            ] },
          11: { title: "Comparatives & Superlatives", vocab: [
              { es: "rápido", en: "fast" }, { es: "lento", en: "slow" }, { es: "caro", en: "expensive" }, { es: "barato", en: "cheap" },
              { es: "mejor", en: "better" }, { es: "peor", en: "worse" }, { es: "mayor", en: "older" }, { es: "menor", en: "younger" }
            ],
            grammar: [
              { title: "Comparatives", desc: "más/menos + adj. + que; tan + adj. + como; tanto/a(s) + noun + como.", examples: [["Esta casa es más grande que esa.", "This house is bigger than that one."]] },
              { title: "Superlatives", desc: "el/la/los/las + más/menos + adj.", examples: [["Es la ciudad más bonita.", "It's the most beautiful city."]] }
            ] },
          12: { title: "Imperatives (Basic) & Requests", vocab: [
              { es: "por favor", en: "please" }, { es: "gracias", en: "thanks" }, { es: "perdón", en: "sorry" },
              { es: "abrir", en: "to open" }, { es: "cerrar", en: "to close" }, { es: "esperar", en: "to wait" },
              { es: "traer", en: "to bring" }, { es: "decir", en: "to say/tell" }, { es: "ayudar", en: "to help" }
            ],
            grammar: [
              { title: "Affirmative tú / usted / ustedes", desc: "tú: 3rd sing. (habla, come, vive); usted: hable, coma, viva; ustedes: hablen, coman, vivan.", examples: [["¡Dime!", "Tell me!"], ["Ábralo, por favor.", "Open it, please."]] },
              { title: "Pronoun placement (affirmative)", desc: "Attach to affirmative commands.", examples: [["Cómpralo.", "Buy it."]] }
            ] }
        }
      },
      A2: { title: "A2 — Elementary", lessonCount: 12, lessons: {} },
      B1: { title: "B1 — Intermediate", lessonCount: 12, lessons: {} },
      B2: { title: "B2 — Upper‑Intermediate", lessonCount: 12, lessons: {} },
      C1: { title: "C1 — Advanced", lessonCount: 10, lessons: {} },
      C2: { title: "C2 — Mastery", lessonCount: 8, lessons: {} }
    };

    // ===== STATE & ELEMENTS =====
    const viewLevels = document.getElementById('view-levels');
    const viewLessons = document.getElementById('view-lessons');
    const viewContent = document.getElementById('view-content');
    const crumbs = document.getElementById('crumbs');
    const backBtn = document.getElementById('backBtn');
    const themeBtn = document.getElementById('themeBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const importCsvBtn = document.getElementById('importCsvBtn');
    const csvFileInput = document.getElementById('csvFile');
    const lessonsGrid = document.getElementById('lessonsGrid');
    const lessonSearch = document.getElementById('lessonSearch');
    const lessonTitle = document.getElementById('lessonTitle');
    const lessonMeta = document.getElementById('lessonMeta');
    const secVocab = document.getElementById('section-vocab');
    const secGrammar = document.getElementById('section-grammar');
    const secQuiz = document.getElementById('section-quiz');
    const lvlTip = document.getElementById('lvlTip');

    let state = { level:null, lesson:null };

    // ===== UTIL =====
    const esc = s=>String(s).replace(/[&<>\"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));
    const randInt = n=>Math.floor(Math.random()*n);

    function normalizeVocab(items){
      const out=[];
      items.forEach(it=>{
        if(it.group) { out.push(it); return; }
        const parts = String(it.es).split('/').map(x=>x.trim()).filter(Boolean);
        const trParts = (it.en||'').split('/').map(x=>x.trim());
        if(parts.length>1){ parts.forEach((p,i)=> out.push({ es:p, en: trParts[i]||it.en, note:it.note })); }
        else { out.push(it); }
      });
      return out;
    }

    function buildAutoQuizFromVocab(vocab, count=5){
      const items=[]; const pool = vocab.slice();
      const options = vocab.map(v=>v.en).filter(Boolean);
      const k = Math.min(count, pool.length);
      for(let i=0;i<k;i++){
        const v = pool[i];
        const wrong = [];
        while(wrong.length<3 && wrong.length < options.length-1){
          const c = options[randInt(options.length)];
          if(c!==v.en && !wrong.includes(c)) wrong.push(c);
        }
        const choices = [...wrong, v.en].sort(()=>Math.random()-.5);
        const answer = choices.indexOf(v.en);
        items.push({ q:`What is the meaning of “${v.es}”?`, choices, answer });
      }
      return items;
    }

    // ===== RENDERERS =====
    function setCrumbs(){
      const parts = [];
      parts.push(`<a href="#" data-nav="home">Levels (A1–C2)</a>`);
      if(state.level){ parts.push(`<span class=\"sep\">/</span><a href=\"#\" data-nav=\"level\">${state.level}</a>`); }
      if(state.lesson){ parts.push(`<span class=\"sep\">/</span><span>Lesson ${state.lesson}</span>`); }
      crumbs.innerHTML = parts.join(' ');
      crumbs.querySelectorAll('a').forEach(a=>a.addEventListener('click',(e)=>{e.preventDefault(); if(a.dataset.nav==='home') goHome(); else showLessons(state.level);}));
      backBtn.hidden = !state.level && !state.lesson;
    }

    function goHome(){ state={level:null, lesson:null}; viewLevels.hidden=false; viewLessons.hidden=true; viewContent.hidden=true; setCrumbs(); window.location.hash=''; }

    function showLevels(){
      const levels = ['A1','A2','B1','B2','C1','C2'];
      const pretty = {A1:'Beginner',A2:'Elementary',B1:'Intermediate',B2:'Upper‑Intermediate',C1:'Advanced',C2:'Mastery'};
      const summaries = {
        A1: 'Understand and use everyday expressions; introduce yourself and others; ask/answer personal details.',
        A2: 'Comprehend sentences on common topics; communicate simple tasks; describe background and routine.',
        B1: 'Handle most travel situations; write simple connected text; describe experiences and events.',
        B2: 'Understand main ideas of complex texts; interact with fluency; produce detailed, clear text.',
        C1: 'Understand demanding texts; express ideas fluently and spontaneously; flexible language use.',
        C2: 'Understand virtually everything; summarize information from sources; express with precision.'
      };
      const grid = document.createElement('div'); grid.className='grid';
      levels.forEach(lvl=>{
        const info = DATA[lvl];
        const el = document.createElement('div'); el.className='card level fadeIn'; el.tabIndex=0; el.setAttribute('role','button'); el.setAttribute('aria-label',`Open ${lvl}`);
        el.dataset.summary = summaries[lvl] || '';
        el.innerHTML = `
          <div class="levelHeader"><div class="lvl">${lvl}</div><div class="lvlTag">${pretty[lvl]}</div></div>
          <div style="margin-top:10px"><span class="badge">${info?.lessonCount || Object.keys(info?.lessons||{}).length} lessons</span></div>`; /* removed muted info.title line */
        const open=()=>showLessons(lvl);
        el.addEventListener('click',open);
        el.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();open();}});
        // hover/focus tooltip
        el.addEventListener('mouseenter',e=>showLevelSummary(el,e));
        el.addEventListener('mousemove',e=>positionTip(e.clientX,e.clientY));
        el.addEventListener('mouseleave',hideLevelSummary);
        el.addEventListener('focus',()=>showLevelSummary(el));
        el.addEventListener('blur',hideLevelSummary);
        grid.appendChild(el);
      });
      viewLevels.innerHTML='';
      const hero=document.createElement('div'); hero.className='card'; hero.style.marginBottom='16px';
      hero.innerHTML=`<div style="display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap"><div><h2 style="margin:.2rem 0 0 0">Start here ✨</h2><p class=\"sub\" style=\"margin:.25rem 0 0 0\">Hover a level to read its summary. Click to open lessons.</p></div></div>`;
      viewLevels.appendChild(hero); viewLevels.appendChild(grid); setCrumbs();
    }

    function showContent(level, lesson){
      state.level=level; state.lesson=lesson; viewLevels.hidden=true; viewLessons.hidden=true; viewContent.hidden=false;
      const L = DATA[level]; const obj = L.lessons[lesson];
      const vItems = normalizeVocab(obj.vocab||[]);
      const autoQuiz = buildAutoQuizFromVocab(vItems, Math.min(6, vItems.length));
      lessonTitle.textContent = `${obj.title || 'Lesson'} — ${level}`;
      lessonMeta.textContent = `Items: ${vItems.length} vocab · ${(obj.grammar?.length||0)} grammar · ${autoQuiz.length} quiz`;
      renderVocab(vItems); renderGrammar(obj.grammar||[]); renderQuiz(autoQuiz);
      setCrumbs(); window.location.hash=`#/${level}/${lesson}`;
      activateTab('vocab');
    }

    function showLessons(level){
      state.level=level; state.lesson=null; viewLevels.hidden=true; viewLessons.hidden=false; viewContent.hidden=true; lessonsGrid.innerHTML='';
      const L = DATA[level]; const count = L.lessonCount || Object.keys(L.lessons||{}).length;
      for(let i=1;i<=count;i++){
        const has = !!L.lessons?.[i];
        const btn = document.createElement('button'); btn.className='lessonBtn fadeIn'; btn.setAttribute('role','listitem');
        btn.innerHTML = `<strong>Lesson ${i}</strong><small>${has?(L.lessons[i].title||'—'):'— add content in DATA —'}</small><span class=\"badge\">${has? 'ready':'empty'}</span>`;
        btn.disabled=!has; btn.title = has? 'Open':'Add content first';
        if(has) btn.addEventListener('click',()=> showContent(level,i));
        lessonsGrid.appendChild(btn);
      }
      setCrumbs(); window.location.hash=`#/${level}`;
    }

    function renderVocab(items){
      const rows = items.map(it=>`<tr><td>${esc(it.es)}</td><td>${esc(it.en||'')}</td><td>${esc(it.note||'')}</td></tr>`).join('');
      secVocab.innerHTML = `
        <div class="topic">
          <h4>Vocabulary list</h4>
          <table><thead><tr><th>Spanish</th><th>English</th><th>Note</th></tr></thead><tbody>${rows}</tbody></table>
          <div class="muted" style="margin-top:6px"><span class="pill">Tip</span> Only pronouns are grouped; other slashed items are auto‑split.</div>
        </div>`;
    }

    function renderGrammar(items){
      secGrammar.innerHTML='';
      items.forEach((g,idx)=>{
        const box=document.createElement('div'); box.className='topic fadeIn';
        const exTable=(g.examples&&g.examples.length)
          ? `<table><thead><tr><th>Example (ES)</th><th>Meaning (EN)</th></tr></thead><tbody>${g.examples.map(r=>`<tr><td>${esc(r[0])}</td><td>${esc(r[1]||'')}</td></tr>`).join('')}</tbody></table>`
          : '';
        box.innerHTML = `<h4>${idx+1}. ${esc(g.title||'Grammar')}</h4><p class="muted">${esc(g.desc||'')}</p>${exTable}`;
        secGrammar.appendChild(box);
      });
    }

    function renderQuiz(items){
      const wrap = document.createElement('div'); wrap.className='topic';
      wrap.innerHTML = `<h4>Quick Quiz</h4><div id="quizWrap"></div>
        <div class="scoreBox"><button id="checkQuiz" class="primary">Check</button><button id="resetQuiz">Reset</button>
        <div class="scoreBig">Score: <span id="scoreOut">0</span></div></div>`;
      secQuiz.innerHTML=''; secQuiz.appendChild(wrap);
      const quizWrap = wrap.querySelector('#quizWrap');

      items.forEach((it,qi)=>{
        const q=document.createElement('div'); q.className='quiz-item';
        q.innerHTML = `<div><strong>${qi+1}.</strong> ${esc(it.q)}</div>`;
        const list=document.createElement('div'); list.className='quiz-choices';
        it.choices.forEach((c,ci)=>{
          const id=`q${qi}c${ci}`;
          const row=document.createElement('label'); row.className='choice'; row.setAttribute('for',id);
          row.innerHTML = `<input type="radio" name="q${qi}" id="${id}" value="${ci}"/> <span>${esc(c)}</span>`;
          list.appendChild(row);
        });
        q.appendChild(list); quizWrap.appendChild(q);
      });

      wrap.querySelector('#checkQuiz').addEventListener('click',()=>{
        let score=0;
        items.forEach((it,qi)=>{
          const radios = quizWrap.querySelectorAll(`input[name="q${qi}"]`);
          const correctIndex = Number(it.answer);
          radios.forEach((r,ci)=>{
            const choiceEl = r.closest('.choice');
            choiceEl.classList.remove('correct','incorrect');
            if(ci===correctIndex){ choiceEl.classList.add('correct'); }
            if(r.checked && ci!==correctIndex){ choiceEl.classList.add('incorrect'); }
          });
          const chosen = quizWrap.querySelector(`input[name="q${qi}"]:checked`);
          if(chosen && Number(chosen.value)===correctIndex) score++;
        });
        wrap.querySelector('#scoreOut').textContent=`${score}/${items.length}`;
      });

      wrap.querySelector('#resetQuiz').addEventListener('click',()=>{
        quizWrap.querySelectorAll('input[type="radio"]').forEach(r=>r.checked=false);
        quizWrap.querySelectorAll('.choice').forEach(el=>el.classList.remove('correct','incorrect'));
        wrap.querySelector('#scoreOut').textContent='0';
      });
    }

    function activateTab(which){
      document.querySelectorAll('.tab').forEach(b=>{ const on=b.dataset.tab===which; b.classList.toggle('active', on); b.setAttribute('aria-selected', on?'true':'false'); });
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      const el=document.getElementById(`section-${which}`); if(el) el.classList.add('active');
    }

    document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>activateTab(btn.dataset.tab)));

    // deep search
    lessonSearch?.addEventListener('input', ()=>{
      const q=(lessonSearch.value||'').trim().toLowerCase();
      const L=DATA[state.level]; if(!L) return;
      Array.from(lessonsGrid.children).forEach((btn,i)=>{
        const idx=i+1; const obj=L.lessons?.[idx];
        if(!q){ btn.style.display='flex'; return; }
        btn.style.display = matchesLessonDeep(obj,q) ? 'flex' : 'none';
      });
    });

    // Back + Hash routing
    backBtn.addEventListener('click',()=>{ if(state.lesson) showLessons(state.level); else goHome(); });
    function restoreFromHash(){ const parts=(location.hash||'').replace('#/','').split('/').filter(Boolean); if(parts.length===0) return goHome(); const [lvl,les]=parts; if(lvl && !les) return showLessons(lvl); if(lvl && les) return showContent(lvl, Number(les)); goHome(); }
    window.addEventListener('hashchange', restoreFromHash);

    // Theme toggle
    themeBtn.addEventListener('click',()=>{ const on=document.body.classList.toggle('light'); themeBtn.setAttribute('aria-pressed', on?'true':'false'); localStorage.setItem('theme', on?'light':'dark'); });
    (function initTheme(){ const pref=localStorage.getItem('theme'); if(pref==='light') document.body.classList.add('light'); })();

    // CSV EXPORT (A1 only for now)
    exportCsvBtn.addEventListener('click',()=>{
      const rows=[['level','lesson','section','a','b','c']];
      const L=DATA.A1.lessons;
      Object.keys(L).forEach(k=>{
        const idx=Number(k); const obj=L[idx];
        normalizeVocab(obj.vocab||[]).forEach(v=> rows.push(['A1',idx,'vocab', v.es||'', v.en||'', v.note||'']));
        (obj.grammar||[]).forEach(g=> rows.push(['A1',idx,'grammar', g.title||'', g.desc||'', JSON.stringify(g.examples||[]) ]));
      });
      const csv = rows.map(r=> r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='spanish_A1_export.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // CSV IMPORT (A1)
    importCsvBtn.addEventListener('click',()=> csvFileInput.click());
    csvFileInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(Boolean);
      lines.shift(); // header
      const idxLevel = 0, idxLesson = 1, idxSection = 2, A=3,B=4,C=5;
      const lessons = DATA.A1.lessons;
      lines.forEach(line=>{
        const cols = line.match(/(?:^|,)(\"(?:[^\"]|\"\")*\"|[^,]*)/g).map(s=> s.replace(/^,/, '').replace(/^\"|\"$/g,'').replace(/\"\"/g,'\"'));
        const level = cols[idxLevel]; if(level!=='A1') return;
        const lesson = Number(cols[idxLesson]); const sec = cols[idxSection];
        lessons[lesson] = lessons[lesson]||{title:`Lesson ${lesson}`, vocab:[], grammar:[]};
        if(sec==='vocab') lessons[lesson].vocab.push({ es: cols[A], en: cols[B], note: cols[C] });
        if(sec==='grammar'){
          let examples=[]; try{ examples = JSON.parse(cols[C]||'[]'); }catch{}
          lessons[lesson].grammar.push({ title: cols[A], desc: cols[B], examples });
        }
      });
      if(state.level==='A1' && state.lesson){ showContent('A1', state.lesson); }
      else if(state.level==='A1'){ showLessons('A1'); }
      alert('CSV imported into A1.');
      csvFileInput.value='';
    });

    // ===== Tooltip helpers =====
    function showLevelSummary(el, e){
      lvlTip.textContent = el.dataset.summary || '';
      lvlTip.style.display = 'block';
      if(e) positionTip(e.clientX, e.clientY); else {
        const r = el.getBoundingClientRect(); positionTip(r.right, r.top+10);
      }
    }
    function hideLevelSummary(){ lvlTip.style.display='none'; }
    function positionTip(x,y){ const pad=16; const w=lvlTip.offsetWidth||280; const h=lvlTip.offsetHeight||60; let nx=x+12, ny=y+12; const vw=window.innerWidth, vh=window.innerHeight; if(nx+w+pad>vw) nx = vw-w-pad; if(ny+h+pad>vh) ny = vh-h-pad; lvlTip.style.left=nx+"px"; lvlTip.style.top=ny+"px"; }

    // Boot
    showLevels(); restoreFromHash();
  </script>
</body>
</html>
